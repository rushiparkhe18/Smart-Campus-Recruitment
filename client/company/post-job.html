<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Post New Job - Prodigy Hire</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@600;700;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
        }
        
        h1, h2, h3, h4 {
            font-family: 'Poppins', sans-serif;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .sidebar-active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .tag {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: #e0e7ff;
            color: #4f46e5;
            border-radius: 9999px;
            font-size: 0.875rem;
            margin: 0.25rem;
        }
        
        .tag .remove {
            margin-left: 0.5rem;
            cursor: pointer;
            opacity: 0.7;
        }
        
        .tag .remove:hover {
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="flex min-h-screen">
        <!-- Sidebar -->
        <aside class="w-64 bg-white shadow-lg fixed h-full overflow-y-auto">
            <div class="p-6">
                <div class="flex items-center gap-3 mb-8">
                    <div class="w-12 h-12 gradient-bg rounded-xl flex items-center justify-center">
                        <i class="fas fa-building text-white text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-gray-800">Prodigy Hire</h1>
                        <p class="text-xs text-gray-500">Recruiter Portal</p>
                    </div>
                </div>
                
                <!-- Company Info -->
                <div id="sidebarCompanyInfo" class="mb-6 p-4 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-lg">
                    <img id="sidebarLogo" src="" alt="Company Logo" class="w-16 h-16 rounded-lg mb-3 object-cover">
                    <h3 id="sidebarCompanyName" class="font-semibold text-gray-800">Loading...</h3>
                    <p id="sidebarIndustry" class="text-sm text-gray-600">-</p>
                </div>
                
                <!-- Navigation -->
                <nav class="space-y-2">
                    <a href="dashboard.html" class="flex items-center gap-3 px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-100 transition">
                        <i class="fas fa-chart-line w-5"></i>
                        <span>Dashboard</span>
                    </a>
                    
                    <a href="post-job.html" class="sidebar-active flex items-center gap-3 px-4 py-3 rounded-lg transition">
                        <i class="fas fa-plus-circle w-5"></i>
                        <span>Post New Job</span>
                    </a>
                    
                    <a href="my-jobs.html" class="flex items-center gap-3 px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-100 transition">
                        <i class="fas fa-briefcase w-5"></i>
                        <span>My Jobs</span>
                    </a>
                    
                    <a href="applicants.html" class="flex items-center gap-3 px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-100 transition">
                        <i class="fas fa-users w-5"></i>
                        <span>Applicants</span>
                    </a>
                    
                    <a href="create-test.html" class="flex items-center gap-3 px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-100 transition">
                        <i class="fas fa-file-alt w-5"></i>
                        <span>Create Test</span>
                    </a>
                    

                    <a href="profile.html" class="flex items-center gap-3 px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-100 transition">
                        <i class="fas fa-building w-5"></i>
                        <span>Company Profile</span>
                    </a>
                    
                    <a href="#" onclick="logout()" class="flex items-center gap-3 px-4 py-3 text-red-600 rounded-lg hover:bg-red-50 transition mt-8">
                        <i class="fas fa-sign-out-alt w-5"></i>
                        <span>Logout</span>
                    </a>
                </nav>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 ml-64 p-8">
            <!-- Header -->
            <div class="mb-8">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">Post New Job</h1>
                <p class="text-gray-600">Create a new job posting to attract talented students</p>
            </div>

            <!-- Job Posting Form -->
            <form id="jobForm" class="bg-white rounded-xl shadow-sm border border-gray-200 p-8">
                <div class="space-y-6">
                    <!-- Job Title -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Job Title <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="title" required placeholder="e.g., Software Development Engineer"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                        <p class="text-xs text-gray-500 mt-1">Min 5 characters, max 100 characters</p>
                    </div>

                    <!-- Job Description -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Job Description <span class="text-red-500">*</span>
                        </label>
                        <textarea id="description" required rows="6" placeholder="Describe the role, responsibilities, and what you're looking for..."
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"></textarea>
                        <p class="text-xs text-gray-500 mt-1">Min 20 characters. Be detailed about the role.</p>
                    </div>

                    <!-- Row: Job Type & Location -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Job Type <span class="text-red-500">*</span>
                            </label>
                            <select id="jobType" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                <option value="">Select Type</option>
                                <option value="Full-Time">Full-Time</option>
                                <option value="Internship">Internship</option>
                                <option value="Part-Time">Part-Time</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Location <span class="text-red-500">*</span>
                            </label>
                            <input type="text" id="location" required placeholder="e.g., Bangalore, India"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                        </div>
                    </div>

                    <!-- Required Skills -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Required Skills <span class="text-red-500">*</span>
                        </label>
                        <div class="flex gap-2 mb-2">
                            <input type="text" id="skillInput" placeholder="Type a skill and press Enter"
                                class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                            <button type="button" onclick="addSkill()" class="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                                <i class="fas fa-plus"></i> Add
                            </button>
                        </div>
                        <div id="skillsContainer" class="min-h-[40px] border border-gray-200 rounded-lg p-3 bg-gray-50"></div>
                        <p class="text-xs text-gray-500 mt-1">Add at least one skill</p>
                    </div>

                    <!-- Salary Range -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Salary Range (Optional)
                        </label>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <input type="number" id="salaryMin" placeholder="Minimum (₹)"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                            </div>
                            <div>
                                <input type="number" id="salaryMax" placeholder="Maximum (₹)"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                            </div>
                        </div>
                    </div>

                    <!-- Eligibility Criteria -->
                    <div class="border-t pt-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Eligibility Criteria</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <!-- Minimum CGPA -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    Minimum CGPA
                                </label>
                                <input type="number" id="minCGPA" min="0" max="10" step="0.1" placeholder="7.0"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                            </div>

                            <!-- Allowed Departments -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    Departments
                                </label>
                                <select id="departments" multiple size="4"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                    <option value="CSE">CSE</option>
                                    <option value="IT">IT</option>
                                    <option value="ECE">ECE</option>
                                    <option value="EEE">EEE</option>
                                    <option value="MECH">MECH</option>
                                    <option value="CIVIL">CIVIL</option>
                                    <option value="OTHER">OTHER</option>
                                </select>
                                <p class="text-xs text-gray-500 mt-1">Hold Ctrl/Cmd to select multiple</p>
                            </div>

                            <!-- Allowed Batches -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    Batches
                                </label>
                                <select id="batches" multiple size="4"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                    <option value="2024">2024</option>
                                    <option value="2025">2025</option>
                                    <option value="2026">2026</option>
                                    <option value="2027">2027</option>
                                    <option value="2028">2028</option>
                                </select>
                                <p class="text-xs text-gray-500 mt-1">Hold Ctrl/Cmd to select multiple</p>
                            </div>
                        </div>
                    </div>

                    <!-- Application Deadline -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Application Deadline <span class="text-red-500">*</span>
                        </label>
                        <input type="datetime-local" id="deadline" required
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex gap-4 pt-6 border-t">
                        <button type="submit" class="px-8 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition font-semibold">
                            <i class="fas fa-paper-plane mr-2"></i>Post Job
                        </button>
                        <button type="button" onclick="resetForm()" class="px-8 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition font-semibold">
                            <i class="fas fa-redo mr-2"></i>Reset
                        </button>
                        <a href="my-jobs.html" class="px-8 py-3 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 transition font-semibold">
                            <i class="fas fa-times mr-2"></i>Cancel
                        </a>
                    </div>
                </div>
            </form>
        </main>
    </div>

    <script>
        const API_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:5000/api' 
            : 'https://prodigy-hire-backend.onrender.com/api';
        let skills = [];

        // Load profile on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadProfile();
            // Set minimum deadline to current date/time
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('deadline').min = now.toISOString().slice(0, 16);
        });

        // Load user profile for sidebar
        async function loadProfile() {
            try {
                const token = localStorage.getItem('accessToken');
                const response = await fetch(`${API_URL}/users/profile`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();
                
                if (data.status === 'success') {
                    const user = data.data.user || data.data;
                    const company = user.companyProfile || {};
                    const companyName = company.companyName || user.name || 'Company';
                    
                    // Generate logo URL
                    let logoUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(companyName)}&size=200&background=667eea&color=fff`;
                    
                    // Try to get logo from website
                    if (company.website) {
                        try {
                            const domain = new URL(company.website).hostname;
                            logoUrl = `https://logo.clearbit.com/${domain}`;
                        } catch (e) {
                            console.log('Invalid website URL');
                        }
                    }
                    
                    const logoElement = document.getElementById('sidebarLogo');
                    logoElement.src = logoUrl;
                    logoElement.onerror = function() {
                        this.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(companyName)}&size=200&background=667eea&color=fff`;
                    };
                    
                    document.getElementById('sidebarCompanyName').textContent = companyName;
                    document.getElementById('sidebarIndustry').textContent = company.industry || 'Technology';
                }
            } catch (error) {
                console.error('Error loading profile:', error);
            }
        }

        // Add skill
        function addSkill() {
            const input = document.getElementById('skillInput');
            const skill = input.value.trim();
            
            if (skill && !skills.includes(skill)) {
                skills.push(skill);
                renderSkills();
                input.value = '';
            }
        }

        // Allow Enter key to add skill
        document.getElementById('skillInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                addSkill();
            }
        });

        // Remove skill
        function removeSkill(skill) {
            skills = skills.filter(s => s !== skill);
            renderSkills();
        }

        // Render skills as tags
        function renderSkills() {
            const container = document.getElementById('skillsContainer');
            if (skills.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-sm">No skills added yet</p>';
                return;
            }
            
            container.innerHTML = skills.map(skill => `
                <span class="tag">
                    ${skill}
                    <span class="remove" onclick="removeSkill('${skill}')">×</span>
                </span>
            `).join('');
        }

        // Handle form submission
        document.getElementById('jobForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            // Validate skills
            if (skills.length === 0) {
                showToast('Please add at least one required skill', 'error');
                return;
            }

            // Get selected departments
            const deptSelect = document.getElementById('departments');
            const departments = Array.from(deptSelect.selectedOptions).map(opt => opt.value);

            // Get selected batches
            const batchSelect = document.getElementById('batches');
            const batches = Array.from(batchSelect.selectedOptions).map(opt => parseInt(opt.value));

            const jobData = {
                title: document.getElementById('title').value,
                description: document.getElementById('description').value,
                skills: skills,
                jobType: document.getElementById('jobType').value,
                location: document.getElementById('location').value,
                salary: {
                    min: parseInt(document.getElementById('salaryMin').value) || 0,
                    max: parseInt(document.getElementById('salaryMax').value) || 0
                },
                eligibility: {
                    minCGPA: parseFloat(document.getElementById('minCGPA').value) || 0,
                    departments: departments.length > 0 ? departments : undefined,
                    batches: batches.length > 0 ? batches : undefined
                },
                deadline: new Date(document.getElementById('deadline').value).toISOString()
            };

            try {
                const token = localStorage.getItem('accessToken');
                const response = await fetch(`${API_URL}/jobs`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(jobData)
                });

                const data = await response.json();

                if (data.status === 'success') {
                    showToast('Job posted successfully!', 'success');
                    setTimeout(() => {
                        window.location.href = 'my-jobs.html';
                    }, 1500);
                } else {
                    showToast(data.message || 'Failed to post job', 'error');
                }
            } catch (error) {
                console.error('Post job error:', error);
                showToast('Network error. Please try again.', 'error');
            }
        });

        // Reset form
        function resetForm() {
            document.getElementById('jobForm').reset();
            skills = [];
            renderSkills();
        }

        // Logout
        function logout() {
            localStorage.clear();
            window.location.href = '../login.html';
        }

        // Toast notification
        function showToast(message, type = 'error') {
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white z-50 ${
                type === 'success' ? 'bg-green-500' : 'bg-red-500'
            }`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transition = 'opacity 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
    </script>
</body>
</html>
